<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gemini Chat ‚Äî Enhanced UI</title>

  <style>
    :root{
      --user-gradient: linear-gradient(135deg,#2575fc,#6a11cb);
      --bot-bg: #f1f1f1;
      --bot-text: #222;
      --default-bg: linear-gradient(120deg,#fdfbfb 0%,#ebedee 100%);
      --header-bg: #ffffff;
      --header-text: #333;
      --glass-bg: rgba(255,255,255,0.65);
    }
    [data-theme="dark"]{
      --bot-bg: #2b2b2b;
      --bot-text: #eee;
      --default-bg: linear-gradient(120deg,#232526 0%,#414345 100%);
      --header-bg: #111;
      --header-text: #f2f2f2;
      --glass-bg: rgba(20,20,20,0.5);
    }

    html,body{height:100%;margin:0;font-family:"Segoe UI", Roboto, Arial, sans-serif;}
    body{
      display:flex;
      flex-direction:column;
      height:100vh;
      background:var(--default-bg);
      transition:background 1s ease;
      overflow:hidden;
    }

    /* -- header -- */
    header{
      height:64px; display:flex; align-items:center; justify-content:space-between;
      padding:0 16px; background:var(--header-bg); color:var(--header-text);
      box-shadow:0 2px 6px rgba(0,0,0,0.08); z-index:40;
      flex-shrink:0;
    }
    header .title{font-weight:600; font-size:18px;}
    .settings-btn{
      background:transparent;border:none;font-size:20px;cursor:pointer;color:var(--header-text);
    }

    /* -- background layers for crossfade -- */
    .bg-layer{
      position:fixed; inset:0; z-index:0; pointer-events:none;
      background-position:center;background-size:cover;background-repeat:no-repeat;
      opacity:0; transition:opacity 1s ease;
    }
    .bg-layer.show{ opacity:1; }

    .overlay{
      position:fixed; inset:0; background:linear-gradient(rgba(255,255,255,0.15), rgba(255,255,255,0.15));
      z-index:1; pointer-events:none;
      transition: background 0.5s ease;
    }
    [data-theme="dark"] .overlay{ background:linear-gradient(rgba(0,0,0,0.35), rgba(0,0,0,0.35)); }

    /* -- sidebar -- */
    .sidebar{
      position:fixed; top:0; left:-320px; width:320px; height:100%; background:var(--glass-bg);
      backdrop-filter: blur(8px); box-shadow:2px 0 12px rgba(0,0,0,0.18); padding:16px; z-index:45;
      transition:left 0.28s cubic-bezier(.2,.9,.3,1);
      overflow:auto;
    }
    .sidebar.open{ left:0; }
    .sidebar .back{ display:inline-block; margin-bottom:12px; padding:8px 10px; border-radius:8px; background:#eee; cursor:pointer; border:none;}
    [data-theme="dark"] .sidebar .back{ background:#333; color:#fff; }

    .sidebar h3{ margin:10px 0 6px; font-size:14px; color:var(--header-text); }
    .sidebar label{ display:block; margin:8px 0; font-size:13px; color:var(--header-text); }
    .control-row{ display:flex; gap:8px; align-items:center; margin:8px 0; }
    .control-row select, .control-row input[type="checkbox"]{ cursor:pointer; }

    /* -- chat area -- */
    .chat-wrap{ position:relative; flex:1; display:flex; flex-direction:column; overflow:hidden; z-index:10; }
    .chat-scroll{ flex:1; overflow:auto; padding:18px 16px 16px; display:flex; flex-direction:column; gap:12px; }

    .msg{
      max-width:78%; padding:10px 14px; border-radius:18px; position:relative; word-wrap:break-word;
      white-space:pre-wrap; box-shadow:0 2px 6px rgba(0,0,0,0.06);
      transform-origin:center; transition:transform .12s ease;
      animation:fadeInUp .28s ease both;
    }
    .msg:hover{ transform:translateY(-2px) scale(1.01); }
    .msg.user{ align-self:flex-end; background:var(--user-gradient); color:#fff; }
    .msg.bot{ align-self:flex-start; background:var(--bot-bg); color:var(--bot-text); }

    .meta{ display:flex; gap:8px; align-items:center; margin-top:8px; font-size:11px; opacity:0.75; }
    .copy-btn{ background:transparent;border:none; cursor:pointer; font-size:12px; opacity:0.8; padding:0 4px; }

    @keyframes fadeInUp{ from{opacity:0; transform:translateY(14px);} to{opacity:1; transform:none;} }

    .typing{ display:flex; gap:6px; align-items:center; padding:8px; }
    .dot{ width:7px;height:7px;background:var(--bot-text);border-radius:50%; opacity:.25; animation:dot 1s infinite; }
    .dot:nth-child(2){ animation-delay:.2s } .dot:nth-child(3){ animation-delay:.4s }
    @keyframes dot{ 0%{opacity:.2; transform:translateY(0);} 50%{opacity:1; transform:translateY(-6px);} 100%{opacity:.2; transform:translateY(0);} }

    /* footer input */
    .footer{ display:flex; gap:10px; align-items:center; padding:12px; border-top:1px solid rgba(0,0,0,0.06); background:var(--header-bg); z-index:30; flex-shrink:0; }
    .input{ flex:1; display:flex; gap:8px; align-items:center; background:rgba(255,255,255,0.85); padding:8px 12px; border-radius:999px; border:1px solid rgba(0,0,0,0.06); }
    [data-theme="dark"] .input{ background: rgba(0,0,0,0.35); }
    .input input{ flex:1; border:none; outline:none; font-size:15px; background:transparent; padding:6px 0; }
    .send-btn{ width:46px; height:46px; border-radius:50%; border:none; background:var(--user-gradient); color:#fff; cursor:pointer; font-weight:700; }

    /* responsive */
    @media (max-width:640px){
      .sidebar{ width:90%; left:-100%; }
    }
    .small{ font-size:12px; opacity:0.8; }
  </style>
</head>
<body>

  <div id="bgA" class="bg-layer"></div>
  <div id="bgB" class="bg-layer"></div>
  <div class="overlay"></div>

  <!-- Header -->
  <header>
    <div class="title">Gemini Chat</div>
    <div>
      <button class="settings-btn" id="openSettings">‚öôÔ∏è</button>
      <button class="small" id="copyAllBtn">Copy All</button>
      <button class="small" id="exportBtn">Export</button>
    </div>
  </header>

  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar" aria-hidden="true">
    <button class="back" id="closeSettings">‚¨Ö Back</button>

    <h3>Character & Voice</h3>
    <div class="control-row">
      <select id="characterSelect" aria-label="Choose character">
        <option value="none">None</option>
        <option value="char1">Character 1</option>
        <option value="char2">Character 2</option>
        <option value="char3">Character 3</option>
      </select>
      <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="0.35">
    </div>
    <label class="small"><input type="checkbox" id="voiceBgToggle"> Voice & Background</label>
    <label class="small"><input type="checkbox" id="ttsToggle"> Enable TTS</label>

    <h3>Theme</h3>
    <label class="small"><input type="checkbox" id="themeToggle"> Dark mode</label>

    <h3>Quick Commands</h3>
    <div class="control-row">
      <button onclick="sendQuick('Hello')">Hello</button>
      <button onclick="sendQuick('Give me a summary')">Summary</button>
    </div>
  </aside>

  <!-- Chat area -->
  <div class="chat-wrap">
    <div id="chatScroll" class="chat-scroll" role="log" aria-live="polite"></div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <div class="input">
      <input id="prompt" placeholder="Type a message ‚Äî try emojis üòä" autocomplete="off" />
    </div>
    <button id="sendBtn" class="send-btn">‚û§</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
  // ==== Config ====
  const resources = {
    char1: { images: ['/images/char1-1.jpg','/images/char1-2.jpg'], audio: '/sounds/char1-loop.mp3' },
    char2: { images: ['/images/char2-1.jpg','/images/char2-2.jpg'], audio: '/sounds/char2-loop.mp3' },
    char3: { images: ['/images/char3-1.jpg','/images/char3-2.jpg'], audio: '/sounds/char3-loop.mp3' },
    defaultBackgroundCSS: getComputedStyle(document.documentElement).getPropertyValue('--default-bg') || 'linear-gradient(120deg,#fdfbfb, #ebedee)'
  };

  // ==== Elements ====
  const chatScroll = document.getElementById('chatScroll');
  const promptEl = document.getElementById('prompt');
  const sendBtn = document.getElementById('sendBtn');
  const openSettings = document.getElementById('openSettings');
  const closeSettings = document.getElementById('closeSettings');
  const sidebar = document.getElementById('sidebar');
  const charSelect = document.getElementById('characterSelect');
  const voiceBgToggle = document.getElementById('voiceBgToggle');
  const ttsToggle = document.getElementById('ttsToggle');
  const themeToggle = document.getElementById('themeToggle');
  const bgA = document.getElementById('bgA');
  const bgB = document.getElementById('bgB');
  const volumeSlider = document.getElementById('volumeSlider');
  const copyAllBtn = document.getElementById('copyAllBtn');
  const exportBtn = document.getElementById('exportBtn');

  let bgVisibleA = true;
  let bgInterval = null;
  let currentChar = 'none';
  let currentIndex = 0;
  let audioPlayer = null;

  document.body.style.background = resources.defaultBackgroundCSS;

  // ==== Sidebar toggles ====
  openSettings.addEventListener('click', ()=>{ sidebar.classList.add('open'); sidebar.setAttribute('aria-hidden','false'); });
  closeSettings.addEventListener('click', ()=>{ sidebar.classList.remove('open'); sidebar.setAttribute('aria-hidden','true'); });

  themeToggle.addEventListener('change', ()=> {
    if(themeToggle.checked) document.body.setAttribute('data-theme','dark');
    else document.body.removeAttribute('data-theme');
  });

  // ==== Character / audio ====
  charSelect.addEventListener('change', ()=> { currentChar = charSelect.value; restartEffectsIfNeeded(); });
  voiceBgToggle.addEventListener('change', ()=> { restartEffectsIfNeeded(); });

  volumeSlider.addEventListener('input', ()=>{ if(audioPlayer) audioPlayer.volume = parseFloat(volumeSlider.value); });

  function restartEffectsIfNeeded(){
    stopAllEffects();
    if(currentChar!=='none' && voiceBgToggle.checked){
      startBackgroundCycle();
      startAudioLoop();
    }
  }

  function startAudioLoop(){
    stopAudioLoop();
    if(currentChar==='none') return;
    const src = resources[currentChar].audio;
    if(!src) return;
    audioPlayer = new Audio(src);
    audioPlayer.loop = true;
    audioPlayer.volume = parseFloat(volumeSlider.value);
    audioPlayer.play().catch(()=>{});
  }

  function stopAudioLoop(){ if(audioPlayer){ audioPlayer.pause(); audioPlayer=null; } }

  function startBackgroundCycle(){
    stopBackgroundCycle();
    currentIndex=0; showImageAt(currentIndex);
    bgInterval = setInterval(()=>{ currentIndex=(currentIndex+1)%resources[currentChar].images.length; showImageAt(currentIndex); },10000);
  }

  function showImageAt(idx){
    const imgs = resources[currentChar]?.images; if(!imgs || imgs.length===0) return;
    const url = imgs[idx%imgs.length];
    if(bgVisibleA){ bgB.style.backgroundImage=`url('${url}')`; bgB.classList.add('show'); bgA.classList.remove('show'); }
    else { bgA.style.backgroundImage=`url('${url}')`; bgA.classList.add('show'); bgB.classList.remove('show'); }
    bgVisibleA = !bgVisibleA;
  }

  function stopBackgroundCycle(){ if(bgInterval){ clearInterval(bgInterval); bgInterval=null; } bgA.classList.remove('show'); bgB.classList.remove('show'); setTimeout(()=>{document.body.style.background=resources.defaultBackgroundCSS;},300); }

  function stopAllEffects(){ stopAudioLoop(); stopBackgroundCycle(); }

  // ==== Chat ====
  function addMessage(text, role='bot'){
    const wrapper=document.createElement('div'); wrapper.className='msg '+(role==='user'?'user':'bot');
    wrapper.innerHTML=marked.parse(text||'');
    const meta=document.createElement('div'); meta.className='meta';
    const ts=document.createElement('div'); ts.textContent=new Date().toLocaleTimeString();
    const cbtn=document.createElement('button'); cbtn.className='copy-btn'; cbtn.title='Copy message'; cbtn.innerText='üìã';
    cbtn.onclick=()=>{navigator.clipboard.writeText(text||'');}; meta.appendChild(ts); meta.appendChild(cbtn);
    wrapper.appendChild(meta);
    chatScroll.appendChild(wrapper); chatScroll.scrollTop=chatScroll.scrollHeight;
  }

  function showTypingIndicator(){
    const t=document.createElement('div'); t.className='msg bot typing';
    t.innerHTML='<div class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>';
    chatScroll.appendChild(t); chatScroll.scrollTop=chatScroll.scrollHeight; return t;
  }

  async function sendMessage(){
    const text=promptEl.value.trim(); if(!text) return;
    addMessage(text,'user'); promptEl.value='';
    const typingEl=showTypingIndicator();

    try{
      const res=await fetch('/api/chat',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ prompt:text }) });
      const data=await res.json(); typingEl.remove();
      const botText=data.reply||'(no reply)'; addMessage(botText,'bot');

      if(ttsToggle.checked){
        if(audioPlayer){ alert('Cannot use TTS while character sound is playing.'); }
        else{ const utt=new SpeechSynthesisUtterance(botText); speechSynthesis.speak(utt); }
      }
      if(voiceBgToggle.checked && currentChar!=='none'){ currentIndex=(currentIndex+1)%resources[currentChar].images.length; showImageAt(currentIndex); }
    }catch(e){ typingEl.remove(); addMessage('Error: '+(e.message||'Network error'),'bot'); }
  }

  sendBtn.addEventListener('click', sendMessage);
  promptEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendMessage(); } });

  function sendQuick(msg){ promptEl.value=msg; sendMessage(); sidebar.classList.remove('open'); }

  // ==== Copy/Export ====
  copyAllBtn.addEventListener('click', ()=>{ navigator.clipboard.writeText(chatScroll.innerText); alert('All chat copied!'); });
  exportBtn.addEventListener('click', ()=>{ const blob=new Blob([chatScroll.innerText],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='chat.txt'; a.click(); });

  window.sendQuick=sendQuick;
  window.addEventListener('load',()=>{ promptEl.focus(); });
  </script>
</body>
</html>
